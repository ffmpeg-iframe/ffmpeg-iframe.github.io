<!DOCTYPE html>
<html>
  <head>
    <script src="coi-serviceworker.js"></script>
    <script src="ffmpeg.js"></script>
    <script>
      const ffmpeg = new FFmpegWASM.FFmpeg({ log: true });
      onload = async () => {
        const baseURL = "https://cdn.jsdelivr.net/npm/@ffmpeg/core-mt@0.12.4/dist/umd";
        await ffmpeg.load({
            coreURL: URL.createObjectURL(await ( await fetch((`${baseURL}/ffmpeg-core.js`))).blob()),
            wasmURL: URL.createObjectURL(await ( await fetch((`${baseURL}/ffmpeg-core.wasm`))).blob()),
            workerURL: URL.createObjectURL(await ( await fetch((`${baseURL}/ffmpeg-core.worker.js`))).blob()),
        });
        window.addEventListener("message", async event => {
          const data = event.data;
          await ffmpeg.createDir("/input");
          await ffmpeg.mount('WORKERFS', {
            files: [data.vid_data, data.aud_data]
          }, "/input");
          await ffmpeg.exec(["-i", "/input/myvid." + data.vid_ext, "-i", "/input/myaud." + data.aud_ext, "-c", "copy", "output." + (data.vid_ext == data.aud_ext ? data.vid_ext : "mkv")]);
          const blobby = new Blob([await ffmpeg.readFile("output." + (data.vid_ext == data.aud_ext ? data.vid_ext : "mkv"))]);
          parent.postMessage(blobby);
          ffmpeg.unmount("/input");
          ffmpeg.deleteDir("/input");
        });
      };
    </script>
  </head>
</html>
